<?xml version="1.0"?>
<!-- This file is part of the DITA Open Toolkit project hosted on 
     Sourceforge.net. See the accompanying license.txt file for 
     applicable licenses.-->
<!-- (c) Copyright IBM Corp. 2004, 2006 All Rights Reserved. -->
<!-- build whole bin and source package for DITA Open Toolkit -->
<project name="build_DITA-OT_package" default="build-all-packages" 
            basedir=".">
  <description>Build source and binary packages for DITA Open Toolkit</description>
  
  <property name="HTMLHelpCompiler" value="C:\Program Files\HTML Help Workshop\hhc.exe"/>  
  <property name="package.output.dir" location="build\"/>
  <property name="package.name.root" value="DITA-OT"/>
  <property name="version" value="1.5"/>
  
  <property name="src.dir" location="src/"/>
  <property name="bin.dir" location="output2/"/>
  <property name="lib.dir" location="lib/"/>
  <property name="doc.dir" location="doc/"/>
  <property name="dtd.dir" location="dtd/"/>
  <property name="schema.dir" location="schema/"/>
  <property name="xsl.dir" location="xsl/"/>
  <property name="demo.dir" location="demo/"/>
  <property name="sample.dir" location="samples/"/>
  <property name="css.dir" location="css/"/>
  <property name="ant.dir" location="ant/"/>
  <property name="resource.dir" location="resource/"/>
  <property name="out.dir" location="out/"/>
  <property name="doc.out.dir" location="out/doc"/>
  
  <property name="dost.jar" location="${lib.dir}/dost.jar" />
  <property name="binary-min" value="DITA-OT${version}_minimal_bin"/>
  <property name="binary-big" value="DITA-OT${version}_full_easy_install_bin" />
  <property name="binary" value="DITA-OT${version}_standard_bin" />
  <property name="source" value="DITA-OT${version}_src" />
  <property name="win32.zip.suffix" value=".zip" />
  <property name="linux.zip.suffix" value=".tar.gz" />
    
  <target name="init-package" depends="clean-package">
    <mkdir dir="${package.output.dir}"/>    
  </target>
  
  <target name="clean-package">
    <delete dir="${package.output.dir}"/>    
  </target>
  
  <target name="init-java" depends="clean-java">
    <mkdir dir="${lib.dir}" />
    <mkdir dir="${bin.dir}"/>
  </target>
  
  <target name="clean-java">
    <delete dir="${lib.dir}/dost.jar"/>
    <delete dir="${bin.dir}"/>
  </target>
  
  <target name="build-java" depends="init-java">
    <javac srcdir="${src.dir}" destdir="${bin.dir}" excludes="com/**,org/dita/dost/junit/**"
      debug="on" source="1.5" target="1.5">
      <classpath location="lib/resolver.jar"></classpath>
    </javac>
  </target>
  
  <target name="package-java" depends="build-java">
	<copy todir="${bin.dir}/resource/">
		<fileset dir="resource" includes="messages.*"/>
	</copy>
    <copy todir="${bin.dir}">
      <fileset dir="${src.dir}" includes="**/*.properties"/>
    </copy>
    <jar destfile="${dost.jar}" basedir="${bin.dir}" manifest="manifest.mf"
           includes="**" />
  </target>
  
  <patternset id="pattern.package.minimum">
  	
  	<exclude name="demo/fo/fop/build/*" />
	<exclude name="demo/fo/fop/conf/*" />
	<exclude name="demo/fo/fop/lib/*" />
	<exclude name="demo/fo/lib/icu4j.jar" />
	<exclude name="build.log"/>
    <include name="*.*"/>
    <include name="css/**"/>
    <include name="dtd/**"/>
    <include name="resource/**"/>
    <include name="schema/**"/>      
    <include name="xsl/**"/>
    <include name="lib/APACHE-LICENSE-2_0.html"/>
    <include name="lib/resolver.jar"/>
    <include name="lib/CatalogManager.properties"/>
    <exclude name="build.number"/>
    <exclude name=".*"/>
  </patternset>
    
  <patternset id="pattern.package.general">
    <include name="*.*"/>
    <include name="ant/**"/>
    <include name="css/**"/>    
    <include name="demo/book/**"/>
  	<include name="demo/elementref/**"/>
   	<include name="demo/enote/**"/>
  	<include name="demo/faq/**"/>
  	<include name="demo/h2d/**"/>
  	<include name="demo/java/**"/>
  	<include name="demo/dita11/**"/>
  	<include name="demo/dita132/**"/>
	<include name="demo/fo/**" />
	<include name="demo/legacypdf/**" />
    <include name="doc/**"/>
    <include name="dtd/**"/>
    <include name="plugins/**"/>
    <include name="resource/**"/>
    <include name="samples/**"/>
    <include name="schema/**"/>      
    <include name="xsl/**"/>
    <include name="lib/APACHE-LICENSE-2_0.html"/>
    <include name="lib/resolver.jar"/>
    <include name="lib/CatalogManager.properties"/>
  	<include name="lib/saxon/**" />
    <exclude name="doc/userguide-orig/**"/>
	<exclude name="doc/ot-userguide/**"/>
    <exclude name="build.number"/>
    <exclude name=".*"/>
  </patternset>
	
	<patternset id="pattern.package.standard">
			
			<exclude name="demo/fo/fop/build/*" />
			<exclude name="demo/fo/fop/conf/*" />
			<exclude name="demo/fo/fop/lib/*" />
			<exclude name="demo/fo/lib/icu4j.jar" />
			<exclude name="build.log"/>
		
			<include name="*.*"/>
		    <include name="ant/**"/>
		    <include name="css/**"/>    
		    <include name="demo/book/**"/>
		  	<include name="demo/elementref/**"/>
		   	<include name="demo/enote/**"/>
		  	<include name="demo/faq/**"/>
		  	<include name="demo/h2d/**"/>
		  	<include name="demo/java/**"/>
		  	<include name="demo/dita11/**"/>
		  	<include name="demo/dita132/**"/>
			<include name="demo/fo/**" />
			<include name="demo/legacypdf/**" />
		    <include name="doc/**"/>
		    <include name="dtd/**"/>
		    <include name="plugins/**"/>
		    <include name="resource/**"/>
		    <include name="samples/**"/>
		    <include name="schema/**"/>      
		    <include name="xsl/**"/>
		    <include name="lib/APACHE-LICENSE-2_0.html"/>
		    <include name="lib/resolver.jar"/>
		    <include name="lib/CatalogManager.properties"/>
		  	<exclude name="lib/saxon/**" />
		    <include name="doc/userguide-orig/**"/>
			<include name="doc/ot-userguide/**"/>
		    <exclude name="build.number"/>
		    <exclude name=".*"/>
	</patternset>
	
  <patternset id="pattern.package.ant">
  	<include name="tools/ant/*.*" />
  	<include name="tools/ant/bin/**" />
  	<include name="tools/ant/lib/**" />
  </patternset>
    
  <target name="package-source">
    <zip destfile="${package.output.dir}/${param.out.file}${win32.zip.suffix}">
      <zipfileset dir="./" prefix="${package.name.root}${version}-src">
        <patternset refid="pattern.package.standard"/>
        <include name="src/**"/>
      	<include name="lib/APACHE-LICENSE-2_0.html"/>
        <exclude name="files.txt"/>
        <exclude name="startcmd.*"/>
      </zipfileset>
    </zip>
    <tar destfile="${package.output.dir}/${param.out.file}${linux.zip.suffix}" 
      compression="gzip" longfile="gnu">
      <tarfileset dir="./" prefix="${package.name.root}${version}-src">
        <patternset refid="pattern.package.standard"/>
        <include name="src/**"/>
      	<include name="lib/APACHE-LICENSE-2_0.html"/>
        <exclude name="files.txt"/>
        <exclude name="startcmd.*"/>
      </tarfileset>
    </tar>
  </target>
  
  <target name="package-binary-minimum">
    <zip destfile="${package.output.dir}/${param.out.file}${win32.zip.suffix}">
      <zipfileset dir="./" prefix="${package.name.root}${version}">
        <patternset refid="pattern.package.minimum"/>
        <include name="lib/dost.jar"/>
        <exclude name="startcmd.*"/>
        <exclude name="buildPackage.xml" />
      </zipfileset>      
    </zip>
    
    <tar destfile="${package.output.dir}/${param.out.file}${linux.zip.suffix}"
      compression="gzip" longfile="gnu">
      <tarfileset dir="./" prefix="${package.name.root}${version}">
        <patternset refid="pattern.package.minimum"/>
        <include name="lib/dost.jar"/>
        <exclude name="startcmd.*"/>
        <exclude name="buildPackage.xml" />
      </tarfileset>      
    </tar>
  </target>
  
  <target name="package-binary-standard">    
    <zip destfile="${package.output.dir}/${param.out.file}${win32.zip.suffix}">
      <zipfileset dir="./" prefix="${package.name.root}${version}">
        <patternset refid="pattern.package.standard"/>
        <include name="lib/dost.jar"/>
      	<include name="lib/APACHE-LICENSE-2_0.html"/>
        <exclude name="startcmd.*"/>
		<exclude name="buildPackage.xml" />
      </zipfileset>
    </zip>
    
    <tar destfile="${package.output.dir}/${param.out.file}${linux.zip.suffix}" 
      compression="gzip" longfile="gnu">
      <tarfileset dir="./" prefix="${package.name.root}${version}">
        <patternset refid="pattern.package.standard"/>
        <include name="lib/dost.jar"/>
      	<include name="lib/APACHE-LICENSE-2_0.html"/>
        <exclude name="startcmd.*"/>
		<exclude name="buildPackage.xml" />
      </tarfileset>
    </tar>
  </target>
  
  <target name="package-binary-full">    
    <zip destfile="${package.output.dir}/${param.out.file}${win32.zip.suffix}">
      <zipfileset dir="./" prefix="${package.name.root}${version}">
        <patternset refid="pattern.package.general"/>
        <include name="lib/*.jar"/>
      	<patternset refid="pattern.package.ant"/>
      	<include name="lib/APACHE-LICENSE-2_0.html"/>
		<include name="lib/ICU_License.html"/>
		<exclude name="buildPackage.xml" />
      </zipfileset>
    </zip>
    
    <tar destfile="${package.output.dir}/${param.out.file}${linux.zip.suffix}" 
      compression="gzip" longfile="gnu">
      <tarfileset dir="./" prefix="${package.name.root}${version}">
        <patternset refid="pattern.package.general"/>
        <include name="lib/*.jar"/>
        <patternset refid="pattern.package.ant"/>
      	<include name="lib/APACHE-LICENSE-2_0.html"/>
		<include name="lib/ICU_License.html"/>
		<exclude name="buildPackage.xml" />
		<exclude name="startcmd.sh"/>
      </tarfileset>
      <tarfileset mode="755" dir="./" prefix="${package.name.root}${version}">
        <include name="startcmd.sh"/>
      </tarfileset>
    </tar>
  </target>
  
  <target name="build-package-source" depends="package-java, update-doc, copy-updated-doc">
    <antcall target="package-source">
      <param name="param.out.file" value="${source}"/>
    </antcall>
  </target>
  
  <target name="build-package-binary" depends="package-java, update-doc, copy-updated-doc">
    <antcall target="package-binary-minimum">
      <param name="param.out.file" value="${binary-min}"/>
    </antcall>
    <antcall target="package-binary-standard">
      <param name="param.out.file" value="${binary}"/>
    </antcall>
    <antcall target="package-binary-full">
      <param name="param.out.file" value="${binary-big}"/>
    </antcall>
  </target>
    
  <target name="build-package-binary-with-buildnum" 
    depends="package-java, update-doc">
    <buildnumber/>
    <tstamp>
      <format property="build.time" pattern="yyyyMMddhhmm"/>
    </tstamp>
    <antcall target="package-binary-min">
      <param name="param.out.file"
        value="${package.name.root}${version}b${build.number}_minimal_bin.${build.time}"/>
    </antcall>
    <antcall target="package-binary-standard">
      <param name="param.out.file" 
        value="${package.name.root}${version}b${build.number}_standard_bin.${build.time}"/>
    </antcall>
    <antcall target="package-binary-full">
      <param name="param.out.file" 
        value="${package.name.root}${version}b${build.number}_full_easy_install_bin.${build.time}"/>
    </antcall>
  </target>
  
  <target name="build-all-packages" depends="init-package, build-package-binary, build-package-source"/>
  
  <target name="update-doc">
    <ant antfile="integrator.xml" target="integrate"/> 
    <ant antfile="build_demo.xml" target="doc.articles.web"/>
    <ant antfile="build_demo.xml" target="doc.articles.chm"/>
    <ant antfile="build_demo.xml" target="doc.articles.pdf">
      <property name="args.fo.img.ext" value=".gif"/>
    </ant>
    <ant antfile="build_demo.xml" target="doc.installguide.web"/>
    <ant antfile="build_demo.xml" target="doc.installguide.pdf">
      <property name="args.fo.img.ext" value=".gif"/>
    </ant>
    <ant antfile="build_demo.xml" target="doc.installguide.chm"/>
    <ant antfile="build_demo.xml" target="doc.readme.web"/>
    <ant antfile="build_demo.xml" target="doc.readme.chm"/>
    <ant antfile="build_demo.xml" target="doc.readme.pdf">
      <property name="args.fo.img.ext" value=".jpg"/>
    </ant>
  </target>
  
  <target name="copy-updated-doc">
    <copy todir="${doc.dir}">
      <fileset dir="${doc.out.dir}">        
        <exclude name="**/*.hhp"/>
        <exclude name="**/*.hhc"/>
        <exclude name="**/*.hhk"/>
        <exclude name="**/*.fo"/>
        <exclude name="**/*.log"/>
        <exclude name="**/*.list"/>
        <exclude name="**/*.temp"/>
        <exclude name="**/*.db"/>
      </fileset>
    </copy>
  </target>
</project>