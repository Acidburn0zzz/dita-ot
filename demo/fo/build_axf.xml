<?xml version="1.0"?>
<!-- This file is part of the DITA Open Toolkit project hosted on 
  Sourceforge.net. See the accompanying license.txt file for 
  applicable licenses.-->
<!-- (c) Copyright IBM Corp. 2011 All Rights Reserved. -->
<project name="org.dita.pdf2.axf">

  <target name="transform.fo2pdf.ah.test-use">
    <condition property="use.ah.pdf.formatter">
      <equals arg1="${pdf.formatter}" arg2="ah"/>
    </condition>
  </target>

  <target name="transform.fo2pdf.ah.init" if="use.ah.pdf.formatter">
    <!-- default output format -->
    <condition property="axf.formatter.output-format" value="@PDF">
      <not><isset property="axf.formatter.output-format"/></not>
    </condition>
    <!-- output file extension -->
    <condition property="xsl.formatter.ext" value=".ps">
      <and>
        <equals arg1="${axf.formatter.output-format}" arg2="@PS"/>
        <not><isset property="xsl.formatter.ext"/></not>
      </and>
    </condition>
    <condition property="xsl.formatter.ext" value=".txt">
      <and>
        <equals arg1="${axf.formatter.output-format}" arg2="@TEXT"/>
        <not><isset property="xsl.formatter.ext"/></not>
      </and>
    </condition>
    <condition property="xsl.formatter.ext" value=".inx">
      <and>
        <equals arg1="${axf.formatter.output-format}" arg2="@INX"/>
        <not><isset property="xsl.formatter.ext"/></not>
      </and>
    </condition>
    <condition property="xsl.formatter.ext" value=".svg">
      <and>
        <equals arg1="${axf.formatter.output-format}" arg2="@SVG"/>
        <not><isset property="xsl.formatter.ext"/></not>
      </and>
    </condition>
    <condition property="xsl.formatter.ext" value=".mda">
      <and>
        <equals arg1="${axf.formatter.output-format}" arg2="@MODCA"/>
        <not><isset property="xsl.formatter.ext"/></not>
      </and>
    </condition>
    <condition property="xsl.formatter.ext" value=".mif">
      <and>
        <equals arg1="${axf.formatter.output-format}" arg2="@MIF"/>
        <not><isset property="xsl.formatter.ext"/></not>
      </and>
    </condition>
    <condition property="xsl.formatter.ext" value=".AT.xml">
      <and>
        <equals arg1="${axf.formatter.output-format}" arg2="@AreaTree"/>
        <not><isset property="xsl.formatter.ext"/></not>
      </and>
    </condition>
    <condition property="xsl.formatter.ext" value=".xps">
      <and>
        <equals arg1="${axf.formatter.output-format}" arg2="@XPS"/>
        <not><isset property="xsl.formatter.ext"/></not>
      </and>
    </condition>
    <condition property="xsl.formatter.ext" value=".pdf">
      <and>
        <equals arg1="${axf.formatter.output-format}" arg2="@PDF"/>
        <not><isset property="xsl.formatter.ext"/></not>
      </and>
    </condition>
  </target>

  <!--Set up and run Antenna House-->
  <target name="transform.fo2pdf.ah" depends="transform.fo2pdf.ah.test-use, transform.fo2pdf.ah.init" if="use.ah.pdf.formatter">
    <condition property="has.axf.option">
      <and>
        <not><equals arg1="${env.AXF_OPT}" arg2=""/></not>
        <available file="${env.AXF_OPT}"/>
      </and>
    </condition>

    <!--We try to hunt for Antenna House in different directories.
      This should really be set externally, but we're incorporating
      existing Antenna House tools which provided this feature.  -->

    <condition property="axf.path" value="${env.AXF_DIR}">
      <and>
        <isset property="env.AXF_DIR"/>
        <or>
          <available file="${env.AXF_DIR}/run.sh"/>
          <available file="${env.AXF_DIR}/XSLCmd.exe"/>
          <available file="${env.AXF_DIR}/AHFCmd.exe"/>
        </or>
      </and>
    </condition>
    <!-- NOTE: At present, there is no Antenna House V6 or V53, and the OT developers
      do not know of a plan for either. They are added here so that if either
      one is released, the Antenna House detection here will continue to work.
      This plan is based on the V52 update, which caused some OT users to lose 
      Antenna House function until this code was updated. -->
    <condition property="axf.path" value="C:\Program Files\AntennaHouse\AHFormatterV6">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files\AntennaHouse\AHFormatterV6\AHFCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files\AntennaHouse\AHFormatterV53">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files\AntennaHouse\AHFormatterV53\AHFCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files\AntennaHouse\AHFormatterV52">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files\AntennaHouse\AHFormatterV52\AHFCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files\AntennaHouse\AHFormatterV51">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files\AntennaHouse\AHFormatterV51\AHFCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files\AntennaHouse\AHFormatterV5">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files\AntennaHouse\AHFormatterV5\AHFCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files\Antenna\XSLFormatterV43">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files\Antenna\XSLFormatterV43\XSLCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files\Antenna\XSLFormatterV42">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files\Antenna\XSLFormatterV42\XSLCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files\Antenna\XSLFormatterV41">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files\Antenna\XSLFormatterV41\XSLCmd.exe"/>
      </and>
    </condition>

    <!-- NOTE: Repeated all of the above trial conditions using "C:\Program Files (x86)"
      instead of "C:\Program Files". AnntenaHouse installs under
      C:\Program Files (x86) for 64-bit Windows operating systems.
    -->
    <condition property="axf.path" value="C:\Program Files (x86)\AntennaHouse\AHFormatterV6">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files (x86)\AntennaHouse\AHFormatterV6\AHFCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files (x86)\AntennaHouse\AHFormatterV53">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files (x86)\AntennaHouse\AHFormatterV53\AHFCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files (x86)\AntennaHouse\AHFormatterV52">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files (x86)\AntennaHouse\AHFormatterV52\AHFCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files (x86)\AntennaHouse\AHFormatterV51">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files (x86)\AntennaHouse\AHFormatterV51\AHFCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files (x86)\AntennaHouse\AHFormatterV5">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files (x86)\AntennaHouse\AHFormatterV5\AHFCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files (x86)\Antenna\XSLFormatterV43">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files (x86)\Antenna\XSLFormatterV43\XSLCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files (x86)\Antenna\XSLFormatterV42">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files (x86)\Antenna\XSLFormatterV42\XSLCmd.exe"/>
      </and>
    </condition>
    <condition property="axf.path" value="C:\Program Files (x86)\Antenna\XSLFormatterV41">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="C:\Program Files (x86)\Antenna\XSLFormatterV41\XSLCmd.exe"/>
      </and>
    </condition>

    <!-- NOTE: Adding V6 and V53 as a guess where the next version will install,
      to try and make this code forward compatible. Basing it on the
      known install location of V52. Also adding V51 based on the 
      known V52 location (V51 support was missing as of the V52 release).
      The _64 values are used for 64 bit machines, and values without _64
      are for 32 bit machines. -->
    <condition property="axf.path" value="/usr/AHFormatterV6_64">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="/usr/AHFormatterV6_64/run.sh" value="/usr/AHFormatterV6_64"/>
      </and>
    </condition>
    <condition property="axf.path" value="/usr/AHFormatterV6">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="/usr/AHFormatterV6/run.sh" value="/usr/AHFormatterV6"/>
      </and>
    </condition>
    <condition property="axf.path" value="/usr/AHFormatterV53_64">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="/usr/AHFormatterV53_64/run.sh" value="/usr/AHFormatterV53_64"/>
      </and>
    </condition>
    <condition property="axf.path" value="/usr/AHFormatterV53">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="/usr/AHFormatterV53/run.sh" value="/usr/AHFormatterV53"/>
      </and>
    </condition>
    <condition property="axf.path" value="/usr/AHFormatterV52_64">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="/usr/AHFormatterV52_64/run.sh" value="/usr/AHFormatterV52_64"/>
      </and>
    </condition>
    <condition property="axf.path" value="/usr/AHFormatterV52">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="/usr/AHFormatterV52/run.sh" value="/usr/AHFormatterV52"/>
      </and>
    </condition>
    <condition property="axf.path" value="/usr/AHFormatterV51">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="/usr/AHFormatterV51/run.sh" value="/usr/AHFormatterV51"/>
      </and>
    </condition>
    <condition property="axf.path" value="/usr/AHFormatterV5">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="/usr/AHFormatterV5/run.sh" value="/usr/AHFormatterV5"/>
      </and>
    </condition>
    <condition property="axf.path" value="/usr/XSLFormatterV43">
      <and>
        <not><isset property="axf.path"/></not>
        <available file="/usr/XSLFormatterV43/run.sh"/>
      </and>
    </condition>

    <!-- run.sh on Linux, AHFCmd.exe or XSLCmd.exe on Windows -->
    <condition property="fo.ah.program.name" value="run.sh">
      <os family="unix"/>
    </condition>
    <condition property="fo.ah.program.name" value="AHFCmd.exe">
      <available file="${axf.path}/AHFCmd.exe"/>
    </condition>
    <condition property="fo.ah.program.name" value="XSLCmd.exe">
      <not><isset property="fo.ah.program.name"/></not>
    </condition>
    
    <condition property="outputFile" value="${dita.map.output.dir}/${outputFile.base}${xsl.formatter.ext}">
      <not><isset property="outputFile"/></not>
    </condition>
    
    <antcall target="transform.fo2pdf.ah.nooption"/>
    <antcall target="transform.fo2pdf.ah.hasoption"/>
  </target>

  <target name="transform.fo2pdf.ah.nooption" unless="has.axf.option">
    <exec executable="${axf.path}/${fo.ah.program.name}" resultproperty="errCode" logerror="true">
      <arg value="-d"/>
      <arg value="${dita.map.output.dir}/topic.fo"/>
      <arg value="-o"/>
      <arg value="${outputFile}"/>
      <arg value="-p"/>
      <arg value="${axf.formatter.output-format}"/>
      <arg value="-extlevel"/>
      <arg value="4"/>
      <arg value="-peb"/>
      <arg value="1"/>
    </exec>
  </target>

  <target name="transform.fo2pdf.ah.hasoption" if="has.axf.option">
    <exec executable="${axf.path}/${fo.ah.program.name}" resultproperty="errCode" logerror="true">
      <arg value="-d"/>
      <arg value="${dita.map.output.dir}/topic.fo"/>
      <arg value="-o"/>
      <arg value="${outputFile}"/>
      <arg value="-p"/>
      <arg value="${axf.formatter.output-format}"/>
      <arg value="-extlevel"/>
      <arg value="4"/>
      <arg value="-peb"/>
      <arg value="1"/>
      <arg value="-i"/>
      <arg value="${env.AXF_OPT}"/>
    </exec>
  </target>

</project>
